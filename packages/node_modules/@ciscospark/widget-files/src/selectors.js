import {createSelector} from 'reselect';

const getShare = (state) => state.share;
const getSpaceId = (state, ownProps) => ownProps.spaceId;
const getSpaces = (state) => state.spaces.get('byId');
const getActivities = (state) => state.activities;

const getSpace = createSelector(
  [getSpaces, getSpaceId],
  (spaces, spaceId) => spaces.get(spaceId)
);

const getSpaceActivities = createSelector(
  [getSpace, getActivities],
  (space, activities) => space.activities.map((details, id) => activities.get(id))
);

const getFilesWidgetProps = createSelector(
  [getSpaceActivities, getShare],
  (activities, share) => {
    const fileShares = [];
    activities
      .filter((activity) => activity.verb === 'share')
      .forEach((activity) => {
        if (activity.object.files && activity.object.files.items.length) {
          activity.object.files.items.forEach((fileItem) => {
            let isFetching = false;
            let objectUrl;
            if (fileItem.image) {
              const thumbnail = fileItem.mimeType === 'image/gif' ? share.getIn(['files', fileItem.url]) : share.getIn(['files', fileItem.image.url]);
              if (thumbnail) {
                isFetching = thumbnail.get('isFetching');
                objectUrl = thumbnail.get('objectUrl');
              }
            }
            const fileShare = {
              actor: activity.actor,
              activityId: activity.id,
              item: {
                ...fileItem,
                isFetching,
                objectUrl
              }
            };
            fileShares.push(fileShare);
          });
        }
      });

    return {fileShares};
  }
);

export default getFilesWidgetProps;
